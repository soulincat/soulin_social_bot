name: Test Secrets Configuration

on:
  workflow_dispatch:  # Manual trigger only

jobs:
  test-secrets:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Test Secrets
        run: |
          echo "üîç Testing GitHub Secrets configuration..."
          echo ""
          
          # Store secrets in variables to avoid bash expansion issues
          TELEGRAM_TOKEN="${{ secrets.TELEGRAM_BOT_TOKEN }}"
          CLIENTS_JSON="${{ secrets.CLIENTS_JSON }}"
          
          # Check TELEGRAM_BOT_TOKEN
          if [ -z "${TELEGRAM_TOKEN}" ] || [ "${#TELEGRAM_TOKEN}" -eq 0 ]; then
            echo "‚ùå TELEGRAM_BOT_TOKEN is NOT set or is empty"
            TELEGRAM_OK=false
          else
            echo "‚úÖ TELEGRAM_BOT_TOKEN is set (length: ${#TELEGRAM_TOKEN} chars)"
            TELEGRAM_OK=true
          fi
          
          # Check CLIENTS_JSON
          if [ -z "${CLIENTS_JSON}" ] || [ "${#CLIENTS_JSON}" -eq 0 ]; then
            echo "‚ùå CLIENTS_JSON is NOT set or is empty"
            CLIENTS_OK=false
          else
            echo "‚úÖ CLIENTS_JSON is set (length: ${#CLIENTS_JSON} chars)"
            # Try to validate JSON
            echo "${CLIENTS_JSON}" > /tmp/test_clients.json
            if python3 -m json.tool /tmp/test_clients.json > /dev/null 2>&1; then
              echo "‚úÖ CLIENTS_JSON is valid JSON"
              CLIENTS_OK=true
            else
              echo "‚ö†Ô∏è CLIENTS_JSON might not be valid JSON (check format)"
              CLIENTS_OK=false
            fi
          fi
          
          # Check optional secrets
          echo ""
          echo "Optional secrets:"
          if [ -z "${{ secrets.BEEHIIV_API_KEY }}" ]; then
            echo "‚ö™ BEEHIIV_API_KEY not set (optional)"
          else
            echo "‚úÖ BEEHIIV_API_KEY is set"
          fi
          
          if [ -z "${{ secrets.INSTAGRAM_ACCESS_TOKEN }}" ]; then
            echo "‚ö™ INSTAGRAM_ACCESS_TOKEN not set (optional)"
          else
            echo "‚úÖ INSTAGRAM_ACCESS_TOKEN is set"
          fi
          
          if [ -z "${{ secrets.VERCEL_TOKEN }}" ]; then
            echo "‚ö™ VERCEL_TOKEN not set (optional)"
          else
            echo "‚úÖ VERCEL_TOKEN is set"
          fi
          
          echo ""
          echo "üìã Summary:"
          if [ "${TELEGRAM_OK}" = "true" ] && [ "${CLIENTS_OK}" = "true" ]; then
            echo "‚úÖ All required secrets are configured!"
            echo "‚úÖ You can now run the weekly report workflow"
          else
            echo "‚ùå Missing or empty required secrets. Please add them in Settings ‚Üí Secrets"
            if [ "${TELEGRAM_OK}" != "true" ]; then
              echo "   - TELEGRAM_BOT_TOKEN is missing or empty"
            fi
            if [ "${CLIENTS_OK}" != "true" ]; then
              echo "   - CLIENTS_JSON is missing or empty"
            fi
            exit 1
          fi

