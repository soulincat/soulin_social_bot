name: Test Secrets Configuration

on:
  workflow_dispatch:  # Manual trigger only

jobs:
  test-secrets:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Test Secrets
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CLIENTS_JSON: ${{ secrets.CLIENTS_JSON }}
        run: |
          echo "üîç Testing GitHub Secrets configuration..."
          echo ""
          
          # Check TELEGRAM_BOT_TOKEN
          if [ -z "${TELEGRAM_TOKEN}" ] || [ "${#TELEGRAM_TOKEN}" -eq 0 ]; then
            echo "‚ùå TELEGRAM_BOT_TOKEN is NOT set or is empty"
            TELEGRAM_OK=false
          else
            echo "‚úÖ TELEGRAM_BOT_TOKEN is set (length: ${#TELEGRAM_TOKEN} chars)"
            TELEGRAM_OK=true
          fi
          
          # Check CLIENTS_JSON - use Python to safely write and validate
          if [ -z "${CLIENTS_JSON}" ] || [ "${#CLIENTS_JSON}" -eq 0 ]; then
            echo "‚ùå CLIENTS_JSON is NOT set or is empty"
            CLIENTS_OK=false
          else
            echo "‚úÖ CLIENTS_JSON is set (length: ${#CLIENTS_JSON} chars)"
            # Use Python to write JSON safely and validate
            python3 << 'PYTHON_SCRIPT'
          import os
          import json
          import sys
          
          clients_json = os.environ.get('CLIENTS_JSON', '')
          if not clients_json:
              sys.exit(1)
          
          try:
              # Write to file
              with open('/tmp/test_clients.json', 'w') as f:
                  f.write(clients_json)
              
              # Validate JSON
              with open('/tmp/test_clients.json', 'r') as f:
                  json.load(f)
              
              print("‚úÖ CLIENTS_JSON is valid JSON")
              sys.exit(0)
          except json.JSONDecodeError as e:
              print(f"‚ö†Ô∏è CLIENTS_JSON is not valid JSON: {e}")
              sys.exit(1)
          except Exception as e:
              print(f"‚ö†Ô∏è Error processing CLIENTS_JSON: {e}")
              sys.exit(1)
          PYTHON_SCRIPT
            
            if [ $? -eq 0 ]; then
              CLIENTS_OK=true
            else
              CLIENTS_OK=false
            fi
          fi
          
          # Check optional secrets
          echo ""
          echo "Optional secrets:"
          if [ -z "${{ secrets.BEEHIIV_API_KEY }}" ]; then
            echo "‚ö™ BEEHIIV_API_KEY not set (optional)"
          else
            echo "‚úÖ BEEHIIV_API_KEY is set"
          fi
          
          if [ -z "${{ secrets.INSTAGRAM_ACCESS_TOKEN }}" ]; then
            echo "‚ö™ INSTAGRAM_ACCESS_TOKEN not set (optional)"
          else
            echo "‚úÖ INSTAGRAM_ACCESS_TOKEN is set"
          fi
          
          if [ -z "${{ secrets.VERCEL_TOKEN }}" ]; then
            echo "‚ö™ VERCEL_TOKEN not set (optional)"
          else
            echo "‚úÖ VERCEL_TOKEN is set"
          fi
          
          echo ""
          echo "üìã Summary:"
          if [ "${TELEGRAM_OK}" = "true" ] && [ "${CLIENTS_OK}" = "true" ]; then
            echo "‚úÖ All required secrets are configured!"
            echo "‚úÖ You can now run the weekly report workflow"
          else
            echo "‚ùå Missing or empty required secrets. Please add them in Settings ‚Üí Secrets"
            if [ "${TELEGRAM_OK}" != "true" ]; then
              echo "   - TELEGRAM_BOT_TOKEN is missing or empty"
            fi
            if [ "${CLIENTS_OK}" != "true" ]; then
              echo "   - CLIENTS_JSON is missing or empty"
            fi
            exit 1
          fi

