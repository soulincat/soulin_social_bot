<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Content Posts - Social Funnel Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Space+Grotesk:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/web/styles/dashboard.css">
</head>
<body style="position: relative; min-height: 100vh; padding-bottom: 3rem;">
    <canvas id="noise-canvas"></canvas>
    <main>
        <header class="app-header">
            <div class="brand-mark">
                <div class="logo-glyph">
                    <img id="user-profile-pic" src="/web/assets/default-avatar.png" alt="Profile" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover; border: 2px solid rgba(168, 85, 247, 0.3);" onerror="this.style.display='none'; this.parentElement.innerHTML='☾';">
                </div>
                <div>
                    <p class="pill-badge" id="project-name">Project</p>
                    <h1>Content Posts</h1>
                </div>
            </div>
            <div class="nav-actions">
                <a href="/workspace" class="ghost-button" style="background: rgba(168, 85, 247, 0.2); border-color: rgba(168, 85, 247, 0.4);">Workspace</a>
                <a href="/" class="ghost-button">Dashboard</a>
                <a href="/content" class="ghost-button">Posts</a>
                <a href="/product" class="ghost-button">Product</a>
                <a href="/brand" class="ghost-button">Brand Identity</a>
                <a href="/settings" class="ghost-button">Settings</a>
                <a href="/content/create" class="glass-button">+ New Post</a>
                <button id="logout-btn" class="ghost-button" onclick="handleLogout()" style="display: none;">Logout</button>
            </div>
        </header>

        <section class="glass-card">
            <div class="panel-title">All Content Posts</div>
            <div style="margin-bottom: 1.5rem; display: flex; gap: 0.75rem; flex-wrap: wrap; align-items: center;">
                <span style="color: #a8b2d1; font-size: 0.9rem;">Filter by status:</span>
                <button class="status-filter-btn" data-status="all" onclick="filterByStatus('all')" style="background: rgba(168, 85, 247, 0.2); border-color: rgba(168, 85, 247, 0.4);">All</button>
                <button class="status-filter-btn" data-status="idea" onclick="filterByStatus('idea')">Idea</button>
                <button class="status-filter-btn" data-status="drafted" onclick="filterByStatus('drafted')">Drafted</button>
                <button class="status-filter-btn" data-status="branched" onclick="filterByStatus('branched')">Branched</button>
                <button class="status-filter-btn" data-status="approved" onclick="filterByStatus('approved')">Approved</button>
                <button class="status-filter-btn" data-status="queued" onclick="filterByStatus('queued')">Queued</button>
                <button class="status-filter-btn" data-status="published" onclick="filterByStatus('published')">Published</button>
            </div>
            <div style="margin-bottom: 1.5rem; display: flex; gap: 0.75rem; flex-wrap: wrap; align-items: center;">
                <span style="color: #a8b2d1; font-size: 0.9rem;">Filter by category:</span>
                <button class="category-filter-btn" data-category="all" onclick="filterByCategory('all')" style="background: rgba(168, 85, 247, 0.2); border-color: rgba(168, 85, 247, 0.4);">All</button>
                <button class="category-filter-btn" data-category="uncategorized" onclick="filterByCategory('uncategorized')">Uncategorized</button>
                <span id="pillar-filters" style="display: flex; gap: 0.5rem; flex-wrap: wrap;"></span>
            </div>
            <div id="posts-list" class="content-list">
                <p style="color: #a8b2d1;">Loading posts...</p>
            </div>
        </section>
        
        <style>
            .status-filter-btn {
                padding: 0.5rem 1rem;
                background: transparent;
                border: 1px solid rgba(255, 255, 255, 0.15);
                border-radius: 8px;
                color: #a8b2d1;
                font-size: 0.85rem;
                font-weight: 500;
                cursor: pointer;
                transition: all 0.2s;
            }
            .status-filter-btn:hover {
                background: rgba(255, 255, 255, 0.05);
                color: #ffffff;
            }
            .status-filter-btn.active {
                background: rgba(168, 85, 247, 0.2);
                border-color: rgba(168, 85, 247, 0.4);
                color: #c084fc;
            }
            .category-filter-btn {
                padding: 0.5rem 1rem;
                background: transparent;
                border: 1px solid rgba(255, 255, 255, 0.15);
                border-radius: 8px;
                color: #a8b2d1;
                font-size: 0.85rem;
                font-weight: 500;
                cursor: pointer;
                transition: all 0.2s;
            }
            .category-filter-btn:hover {
                background: rgba(255, 255, 255, 0.05);
                color: #ffffff;
            }
            .category-filter-btn.active {
                background: rgba(168, 85, 247, 0.2);
                border-color: rgba(168, 85, 247, 0.4);
                color: #c084fc;
            }
        </style>
    </main>

    <script>
        let allPosts = [];
        let allPillars = [];
        let currentStatusFilter = 'all';
        let currentCategoryFilter = 'all';
        
        // Filter posts by status
        function filterByStatus(status) {
            currentStatusFilter = status;
            
            // Update button states
            document.querySelectorAll('.status-filter-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.status === status) {
                    btn.classList.add('active');
                }
            });
            
            renderPosts();
        }
        
        // Filter posts by category/pillar
        function filterByCategory(category) {
            currentCategoryFilter = category;
            
            // Update button states
            document.querySelectorAll('.category-filter-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.category === category) {
                    btn.classList.add('active');
                }
            });
            
            renderPosts();
        }
        
        // Render posts based on current filters
        function renderPosts() {
            let filteredPosts = allPosts;
            
            // Apply status filter
            if (currentStatusFilter !== 'all') {
                filteredPosts = filteredPosts.filter(post => post.status === currentStatusFilter);
            }
            
            // Apply category filter
            if (currentCategoryFilter !== 'all') {
                if (currentCategoryFilter === 'uncategorized') {
                    filteredPosts = filteredPosts.filter(post => !post.pillar_id);
                } else {
                    filteredPosts = filteredPosts.filter(post => post.pillar_id === currentCategoryFilter);
                }
            }
            
            const listEl = document.getElementById('posts-list');
            
            if (filteredPosts.length === 0) {
                listEl.innerHTML = (currentStatusFilter === 'all' && currentCategoryFilter === 'all')
                    ? '<p style="color: #a8b2d1;">No posts yet. <a href="/content/create" style="color: #a855f7;">Create your first post</a></p>'
                    : `<p style="color: #a8b2d1;">No posts match the selected filters.</p>`;
                return;
            }
            
            listEl.innerHTML = filteredPosts.map(post => {
                const statusColor = {
                    'idea': '#a8b2d1',
                    'drafted': '#60a5fa',
                    'branched': '#f59e0b',
                    'approved': '#a855f7',
                    'queued': '#38bdf8',
                    'published': '#22c55e'
                }[post.status] || '#a8b2d1';
                
                // Find pillar name if exists
                const pillar = allPillars.find(p => p.id === post.pillar_id);
                const pillarName = pillar ? pillar.name : null;
                
                const displayTitle = post.center_post?.title || post.raw_idea?.substring(0, 60) || 'Untitled';
                const displayIdea = post.raw_idea ? (post.raw_idea.length > 100 ? post.raw_idea.substring(0, 100) + '...' : post.raw_idea) : '';
                
                return `
                    <article class="glass-card" style="margin-bottom: 1rem; cursor: pointer;" onclick="window.location.href='/content/${post.id}'">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div style="flex: 1;">
                                <h3 style="margin: 0 0 0.5rem;">${displayTitle}</h3>
                                ${displayIdea && post.center_post ? `
                                    <p style="color: #a8b2d1; margin: 0.25rem 0 0.5rem 0; font-size: 0.85rem; font-style: italic;">
                                        "${displayIdea}"
                                    </p>
                                ` : ''}
                                <p style="color: #a8b2d1; margin: 0.25rem 0; font-size: 0.85rem;">
                                    <span style="color: ${statusColor}; font-weight: 500;">${post.status}</span> • ${post.center_post?.word_count || 0} words
                                    ${pillarName ? ` • <span style="color: ${pillar.color || '#a855f7'}; font-size: 0.8rem;">${pillarName}</span>` : ' • <span style="color: #a8b2d1; font-size: 0.8rem;">Uncategorized</span>'}
                                </p>
                                <p style="color: #a8b2d1; margin: 0.25rem 0; font-size: 0.75rem;">
                                    ${new Date(post.created_at).toLocaleDateString()}
                                </p>
                            </div>
                            <div style="display: flex; gap: 0.5rem; flex-direction: column;">
                                ${post.derivatives_count > 0 ? `<span style="font-size: 0.75rem; color: #22c55e;">${post.derivatives_count} socials</span>` : ''}
                            </div>
                        </div>
                    </article>
                `;
            }).join('');
        }
        
        // Load pillars and create filter buttons
        async function loadPillars() {
            try {
                const response = await fetch('/api/content/pillars');
                const data = await response.json();
                allPillars = data.pillars || [];
                
                const pillarFiltersEl = document.getElementById('pillar-filters');
                allPillars.forEach(pillar => {
                    const btn = document.createElement('button');
                    btn.className = 'category-filter-btn';
                    btn.dataset.category = pillar.id;
                    btn.textContent = pillar.name;
                    btn.style.borderColor = pillar.color || 'rgba(255, 255, 255, 0.15)';
                    btn.onclick = () => filterByCategory(pillar.id);
                    pillarFiltersEl.appendChild(btn);
                });
            } catch (error) {
                console.error('Error loading pillars:', error);
            }
        }
        
        // Load posts on page load
        async function loadPosts() {
            try {
                const response = await fetch('/api/content/posts');
                const data = await response.json();
                const posts = data.posts || [];
                
                // Load derivatives count for each post
                allPosts = await Promise.all(posts.map(async (post) => {
                    try {
                        const derivResponse = await fetch(`/api/content/derivatives?post_id=${post.id}`);
                        const derivData = await derivResponse.json();
                        post.derivatives_count = derivData.derivatives?.length || 0;
                    } catch (e) {
                        post.derivatives_count = 0;
                    }
                    return post;
                }));
                
                // Set initial filter button states
                document.querySelector('[data-status="all"]').classList.add('active');
                document.querySelector('[data-category="all"]').classList.add('active');
                
                renderPosts();
            } catch (error) {
                document.getElementById('posts-list').innerHTML = `<p style="color: #f87171;">Error loading posts: ${error.message}</p>`;
            }
        }
        
        // Load both pillars and posts
        loadPillars();
        loadPosts();
        
        // Noise canvas (same as dashboard)
        (function() {
            const canvas = document.getElementById('noise-canvas');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            function resizeCanvas() {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
            }
            function generateNoise() {
                const imageData = ctx.createImageData(canvas.width, canvas.height);
                const data = imageData.data;
                for (let i = 0; i < data.length; i += 4) {
                    const value = Math.random() * 255;
                    data[i] = value;
                    data[i + 1] = value;
                    data[i + 2] = value;
                    data[i + 3] = 15;
                }
                ctx.putImageData(imageData, 0, 0);
            }
            resizeCanvas();
            generateNoise();
            window.addEventListener('resize', () => {
                resizeCanvas();
                generateNoise();
            });
        })();

        // Authentication functions
        async function checkAuth() {
            try {
                const token = sessionStorage.getItem('access_token');
                const headers = {};
                if (token) {
                    headers['Authorization'] = `Bearer ${token}`;
                }
                
                const response = await fetch('/api/auth/me', {
                    headers: headers,
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const logoutBtn = document.getElementById('logout-btn');
                    if (logoutBtn) {
                        logoutBtn.style.display = 'block';
                    }
                    // Load user profile picture if available
                    loadUserProfilePicture(data.user);
                    // Load first client name if available
                    loadFirstClientName();
                }
            } catch (error) {
                console.error('Auth check failed:', error);
            }
        }

        async function handleLogout() {
            try {
                await fetch('/api/auth/logout', { 
                    method: 'POST',
                    credentials: 'include'
                });
                sessionStorage.removeItem('access_token');
                window.location.href = '/login';
            } catch (error) {
                console.error('Logout error:', error);
                window.location.href = '/login';
            }
        }

        // Load client name for navigation
        async function loadFirstClientName() {
            try {
                const token = sessionStorage.getItem('access_token');
                const headers = {};
                if (token) {
                    headers['Authorization'] = `Bearer ${token}`;
                }
                
                const response = await fetch('/api/clients', {
                    headers: headers,
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const client = data.clients?.[0];
                    const projectNameEl = document.getElementById('project-name');
                    if (projectNameEl && client) {
                        projectNameEl.textContent = client.name || 'Project';
                    }
                }
            } catch (error) {
                console.error('Error loading client name:', error);
            }
        }
        
        // Load user profile picture
        async function loadUserProfilePicture(user) {
            if (!user) return;
            const profilePicEl = document.getElementById('user-profile-pic');
            if (!profilePicEl) return;
            
            // Try to get profile picture from user metadata or social links
            // For now, use default image. User can provide their own image later.
            // TODO: Fetch from social media profile if available
            const defaultPic = '/web/assets/default-avatar.png';
            profilePicEl.src = defaultPic;
        }

        checkAuth();
    </script>
    
    <footer style="position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); text-align: center; padding: 1rem; color: rgba(168, 178, 209, 0.6); font-size: 0.875rem; pointer-events: none; width: 100%;">
        <p style="margin: 0;">
            Built by <a href="https://soulin.co" target="_blank" rel="noopener noreferrer" style="color: #203EAE; text-decoration: none; transition: color 0.2s ease; pointer-events: auto;">©SOULIN</a>
        </p>
    </footer>
</body>
</html>

